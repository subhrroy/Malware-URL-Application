package com.cisco.security.urllookup.service.impl;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.apache.commons.codec.digest.DigestUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.cisco.security.urllookup.controllers.URLLookupController;
import com.cisco.security.urllookup.dao.UrlDao;
import com.cisco.security.urllookup.model.URLDetails;
import com.cisco.security.urllookup.service.UrlLookupService;

@Service
public class UrlLookupServiceImpl implements UrlLookupService {

	protected Logger logger = LoggerFactory.getLogger(URLLookupController.class);

	@Autowired
	UrlDao urlDao;

	@Override
	public Map<String, Object> checkUrlValidity(String url) throws Exception {

		Map<String, Object> resultMap = new HashMap<>();
		List<String> errorMessages = new ArrayList<>();

		if (url == null) {
			errorMessages.add("Please send a valid URI.");
			resultMap.put("Status", "Failed");
			resultMap.put("message", errorMessages);
			return resultMap;
		}

		Optional<URLDetails> urlDetails = urlDao.findById(DigestUtils.md5Hex(url));
		if (urlDetails.isPresent()) {
			resultMap.put("Status", "Success");
			resultMap.put("isSafeURI", urlDetails.get().isSafe());
		} else {
			resultMap.put("Status", "Success");
			resultMap.put("isSafeURI", true);
		}

		return resultMap;
	}

	@Override
	public Map<String, Object> addMalwareURL(String url, boolean isSafe) throws Exception {
		Map<String, Object> resultMap = new HashMap<>();
		List<String> errorMessages = new ArrayList<>();
		try {
			URLDetails usrDetails = new URLDetails();
			usrDetails.setId(DigestUtils.md5Hex(url));
			usrDetails.setFullUrl(url);
			usrDetails.setSafe(isSafe);
			usrDetails.setLastModifedDate(new Date());
			urlDao.save(usrDetails);

			resultMap.put("Status", "Success");
			resultMap.put("id", usrDetails.getId());
			resultMap.put("url", url);
		} catch (Exception e) {
			resultMap.put("Status", "Failed");
			resultMap.put("url", url);
			errorMessages.add("Failed to add url in db");
			resultMap.put("message", errorMessages);
		}
		return resultMap;
	}

}
